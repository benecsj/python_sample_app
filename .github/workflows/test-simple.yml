name: Run Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install -r requirements.txt

    - name: Show Python environment
      run: |
        echo "üêç Python Environment:"
        python --version
        pip list

    - name: Run comprehensive test suite
      run: |
        echo "üß™ Running comprehensive test suite..."
        python run_all_tests.py

    - name: Comment on PR results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: checkRuns } = await github.rest.checks.listForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: context.sha,
          });
          
          const testCheck = checkRuns.check_runs.find(check => check.name === 'Run Tests');
          
          if (testCheck && testCheck.conclusion === 'success') {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **All tests passed!**\n\nAll tests are passing successfully. This PR is ready for review.'
            });
          } else if (testCheck && testCheck.conclusion === 'failure') {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Tests failed!**\n\nSome tests are failing. Please check the test results and fix the issues before merging.'
            });
          }